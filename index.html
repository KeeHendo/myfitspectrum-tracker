<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="MyFitSpectrum">
<title>MyFitSpectrum Group Progress Tracker</title>
<style>
  :root { --bw: #222; --muted:#555; --alt:#f6f6f6; }
  *{box-sizing:border-box}
  body{margin:0;padding:16px;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  h1{margin:0 0 6px;font-size:20px}
  h2{margin:16px 0 8px;font-size:16px}
  .appbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  .spacer{flex:1}
  button,select,input[type="date"],input[type="text"]{border:1px solid var(--bw);background:#fff;padding:8px 10px;border-radius:8px;font-size:14px;cursor:pointer}
  button{font-weight:600}
  button.primary{background:#000;color:#fff}
  button.ghost{background:#fff}
  button:disabled{opacity:.5;cursor:not-allowed}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:12px}
  .card{border:1px solid var(--bw);border-radius:12px;padding:12px;background:#fff}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .row label{font-size:13px;color:#000;min-width:90px}
  .muted{color:var(--muted);font-size:12px}
  .legend{display:flex;gap:12px;flex-wrap:wrap;font-size:12px}
  .legend span{border:1px solid var(--bw);border-radius:999px;padding:2px 8px;background:#fff;cursor:pointer;transition:background-color 0.2s}
  .legend span:hover{background:#f0f0f0}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--bw);padding:6px 8px;text-align:left;vertical-align:top;font-size:13px}
  thead th{background:#eaeaea;position:sticky;top:0;z-index:1}
  tbody tr:nth-child(odd){background:var(--alt)}
  .small{font-size:12px}
  .name-input,.notes{width:100%;border:none;outline:none;background:transparent;font-size:13px}
  .notes{min-height:30px;resize:vertical}
  .select{width:100%;background:#fff}
  .sticky-actions{position:sticky;bottom:0;background:#fff;padding-top:10px;border-top:1px dashed var(--bw);margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
  .tabs{display:flex;gap:8px;margin-bottom:8px}
  .tab{border:1px solid var(--bw);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer;font-weight:600}
  .tab.active{background:#000;color:#fff}
  .totals{margin-top:8px;font-size:13px}
  .section{margin-top:12px}
  @media(max-width:980px){
    .grid{grid-template-columns:1fr}
    /* Stack left panel on top for mobile */
    .grid > .card:first-child{order:1;margin-bottom:15px}
    .grid > .card:last-child{order:2}
  }
  @media(max-width:768px){
    body{padding:8px}
    h1{font-size:18px}
    .appbar{flex-direction:column;gap:6px;align-items:stretch}
    .appbar > div:first-child{justify-content:center}
    .appbar > div:first-child img{width:40px;height:40px}
    .grid{gap:15px;display:block}
    .card{padding:12px;margin-bottom:15px}
    .row{flex-direction:column;align-items:stretch;gap:6px}
    .row label{min-width:auto;font-weight:600;font-size:14px}
    input,select,button{padding:12px;font-size:16px;min-height:48px;border-radius:10px}
    input[type="text"], input[type="date"]{background:#f8f9fa;border:2px solid #e9ecef}
    input[type="text"]:focus, input[type="date"]:focus{border-color:#007bff;background:#fff;outline:none}
    .tabs{flex-wrap:wrap;gap:8px;justify-content:center}
    .tab{font-size:15px;padding:10px 16px;min-height:44px}
    
    /* Mobile table optimizations */
    .card h2{margin-bottom:10px}
    .card > div:nth-child(2){max-height:50vh !important;margin-bottom:10px}
    table{font-size:13px;width:100%}
    th,td{padding:8px 6px;min-width:70px;white-space:nowrap}
    th{font-size:12px;font-weight:600;background:#eaeaea !important}
    .name-input,.notes{font-size:15px;padding:8px;background:#f8f9fa;border-radius:6px;width:100%}
    .name-input:focus,.notes:focus{background:#fff;border:2px solid #007bff}
    .notes{min-height:60px;resize:vertical;white-space:normal}
    .select{font-size:15px;padding:10px;background:#f8f9fa;border:2px solid #e9ecef;border-radius:8px;width:100%}
    .select:focus{border-color:#007bff;background:#fff}
    
    /* Template buttons */
    .legend{gap:8px;justify-content:center;flex-wrap:wrap}
    .legend span{font-size:12px;padding:8px 12px;min-height:40px;display:flex;align-items:center;justify-content:center;text-align:center}
    .legend span:active{background:#e9ecef;transform:scale(0.95)}
    
    /* Action buttons */
    .sticky-actions{flex-direction:column;gap:10px;padding:15px 0;position:static}
    .sticky-actions button{width:100%;min-height:50px;font-size:16px;font-weight:600}
    .button.primary{background:#007bff;box-shadow:0 2px 4px rgba(0,123,255,0.3)}
    .totals{font-size:13px;text-align:center;padding:10px;background:#f8f9fa;border-radius:8px;margin:10px 0}
    .small{font-size:12px}
    
    /* Better mobile table scrolling */
    .card > div:nth-child(2){overflow-x:auto;-webkit-overflow-scrolling:touch;border-radius:10px}
    th:first-child, td:first-child{position:sticky;left:0;z-index:2;background:#eaeaea;border-right:2px solid #007bff}
    th:nth-child(2), td:nth-child(2){position:sticky;left:50px;z-index:2;background:#eaeaea;border-right:2px solid #007bff;min-width:130px}
    tbody tr:nth-child(odd) td:first-child{background:#f8f9fa}
    tbody tr:nth-child(odd) td:nth-child(2){background:#f8f9fa}
    tbody tr:nth-child(even) td:first-child{background:#fff}
    tbody tr:nth-child(even) td:nth-child(2){background:#fff}
  }
  @media(max-width:480px){
    body{padding:6px}
    h1{font-size:16px;line-height:1.2}
    .appbar > div:first-child{gap:8px}
    .appbar > div:first-child img{width:36px;height:36px}
    .card{padding:10px;margin-bottom:10px}
    .row{gap:4px}
    input,select,button{padding:14px;font-size:16px;min-height:50px}
    .tabs{gap:6px}
    .tab{font-size:14px;padding:12px 14px;min-height:46px}
    
    /* Compact table for small screens */
    .card h2{font-size:16px;margin-bottom:8px}
    .card > div:nth-child(2){max-height:45vh !important}
    table{font-size:12px}
    th,td{padding:6px 4px;min-width:60px}
    th{font-size:11px}
    .name-input,.notes{font-size:16px;padding:10px}
    .notes{min-height:60px}
    .select{font-size:16px;padding:12px}
    
    /* Compact template buttons */
    .legend{gap:6px;margin:8px 0}
    .legend span{font-size:11px;padding:6px 8px;min-height:36px;line-height:1.2}
    .sticky-actions{padding:10px 0}
    .sticky-actions button{min-height:52px;font-size:17px}
    
    /* Enhanced sticky columns for small screens */
    th:first-child, td:first-child{left:0;min-width:35px;font-size:11px;padding:4px 2px}
    th:nth-child(2), td:nth-child(2){left:35px;min-width:110px;padding:6px 4px}
    
    /* Clear swipe indicator */
    .card h2:after{content:" ← Swipe table to scroll →";font-size:10px;color:var(--muted);font-weight:normal;display:block;margin-top:4px}
    .totals{font-size:12px;padding:8px;margin:8px 0}
    
    /* Better section spacing */
    .section{margin-top:15px}
    h2.section{font-size:15px}
  }
  @media print{
    .appbar,.sticky-actions,.tabs{display:none!important} 
    body{padding:0;margin:0;font-size:12px} 
    .card{border:none;padding:8px;page-break-inside:avoid} 
    thead th{position:static;background:#eaeaea !important}
    table{width:100%;font-size:11px;page-break-inside:avoid}
    th,td{padding:4px 6px;border:1px solid #000 !important}
    .report{border:none;padding:0;margin:0}
    .section{page-break-inside:avoid;margin-top:15px}
    .chart{page-break-inside:avoid}
    h2{font-size:14px;margin:10px 0 5px 0}
    .small{font-size:10px}
    .muted{color:#000 !important}
    @page{margin:0.5in;size:landscape}
  }
  /* Report styles */
  .report{border:1px solid var(--bw);border-radius:12px;padding:12px;background:#fff}
  .hr{border-top:1px dashed var(--bw);margin:10px 0}
  /* Chart styles */
  .chart{margin:20px 0;padding:15px;border:1px solid var(--bw);border-radius:8px;background:#fff}
  .chart-container{position:relative;height:300px;width:100%}
  .chart-bars{display:flex;align-items:end;height:250px;gap:20px;padding:10px 0;border-bottom:2px solid var(--bw)}
  .chart-group{display:flex;flex-direction:column;align-items:center;flex:1;gap:5px}
  .chart-group-bars{display:flex;gap:5px;align-items:end;height:200px}
  .chart-bar{width:25px;border-radius:4px 4px 0 0;position:relative;min-height:10px}
  .chart-bar.baseline{background:#4a90e2}
  .chart-bar.average{background:#7ed321}
  .chart-label{font-size:11px;text-align:center;font-weight:600;margin-top:8px;line-height:1.2}
  .chart-legend{display:flex;justify-content:center;gap:20px;margin-top:15px;font-size:12px}
  .chart-legend-item{display:flex;align-items:center;gap:5px}
  .chart-legend-color{width:20px;height:15px;border-radius:3px}
  .chart-value{position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:10px;font-weight:600;color:#333}
  .chart-y-axis{position:absolute;left:-25px;top:0;height:250px;display:flex;flex-direction:column-reverse;justify-content:space-between;font-size:10px;color:var(--muted)}
</style>
</head>
<body>

<div class="appbar">
  <div style="display: flex; align-items: center; gap: 12px;">
    <img src="logo.png" alt="MyFitSpectrum Logo" style="width: 48px; height: 48px; border-radius: 12px;">
    <h1>MyFitSpectrum Group Progress Tracker</h1>
  </div>
  <div class="spacer"></div>
  <button class="ghost" onclick="print()">Print</button>
  <button class="ghost" onclick="exportCSV()">Export CSV</button>
  <button class="ghost" onclick="exportJSON()">Export JSON</button>
  <label class="small" for="importJson" style="cursor:pointer;border:1px solid #222;padding:6px 10px;border-radius:8px;">Import JSON</label>
  <input id="importJson" type="file" accept="application/json" style="display:none" />
</div>

<div class="tabs">
  <button class="tab active" id="tabTrack" onclick="switchTab('track')">Track Session</button>
  <button class="tab" id="tabReport" onclick="switchTab('report')">Monthly Reports</button>
  <button class="tab" id="tabSessions" onclick="switchTab('sessions')">Saved Sessions</button>
</div>

<div id="viewTrack">
  <div class="grid">
    <!-- Left controls -->
    <div class="card">
      <h2>Session Details</h2>
      <div class="row"><label>Group Name</label><input id="groupName" class="grow" type="text" placeholder="e.g., Group 1 — Tue AM" /></div>
      <div class="row"><label>Date</label><input id="sessionDate" type="date" /></div>
      <div class="row"><label>Coach</label><input id="coachName" class="grow" type="text" placeholder="Your name" /></div>

      <h2 class="section">Quick Setup</h2>
      <div class="row"><button class="ghost" onclick="resetNames()">Reset Names</button><button class="ghost" onclick="seedNames()">Auto-fill Names</button></div>
      <div class="row"><button class="ghost" onclick="fillBaseline(3)">Set All Baselines = 3</button><button class="ghost" onclick="clearScores()">Clear All Scores</button></div>

      <h2 class="section">Quick Note Templates</h2>
      <div class="legend">
        <span onclick="addTemplateNote('Excellent effort and motivation')">Excellent Effort</span>
        <span onclick="addTemplateNote('Needed several breaks during session')">Needed Breaks</span>
        <span onclick="addTemplateNote('Required frequent verbal prompts')">Needed Prompts</span>
        <span onclick="addTemplateNote('Great social interaction with peers')">Good Social Skills</span>
        <span onclick="addTemplateNote('Showed improvement from baseline')">Showed Improvement</span>
        <span onclick="addTemplateNote('Maintained focus throughout session')">Good Focus</span>
        <span onclick="addTemplateNote('Struggled with coordination tasks')">Coordination Challenges</span>
        <span onclick="addTemplateNote('Self-regulated behavior well')">Good Self-Regulation</span>
      </div>
      <p class="muted small">Click any template to add to the currently focused notes field</p>
      
      <h2 class="section">Rating Scale Guide</h2>
      <p class="muted"><b>Domains:</b> Strength & Coordination, Focus & Engagement, Social Participation, Self-Regulation</p>
      <div class="muted small" style="line-height: 1.4;">
        <b>1 - Maximum Support:</b> Requires full physical/verbal assistance and prompting<br>
        <b>2 - Moderate Support:</b> Needs frequent assistance and regular prompting<br>
        <b>3 - Some Support:</b> Occasional assistance needed, responds well to prompts<br>
        <b>4 - Minimal Support:</b> Mostly independent, minimal prompting required<br>
        <b>5 - Independent:</b> Fully independent, no assistance or prompting needed
      </div>
    </div>

    <!-- Right table -->
    <div class="card">
      <h2>Participants (up to 15)</h2>
      <div style="overflow:auto; max-height: 60vh; border:1px solid var(--bw); border-radius: 8px; -webkit-overflow-scrolling: touch;">
        <table id="trackerTable">
          <thead>
            <tr>
              <th style="position:sticky;left:0;background:#eaeaea;z-index:2;">#</th>
              <th style="position:sticky;left:40px;background:#eaeaea;z-index:2;min-width:120px;">Participant</th>
              <th>Strength Base</th><th>Strength Current</th>
              <th>Focus Base</th><th>Focus Current</th>
              <th>Social Base</th><th>Social Current</th>
              <th>Regulation Base</th><th>Regulation Current</th>
              <th style="min-width:150px;">Notes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="totals" id="averages">Group Averages — Strength: – | Focus: – | Social: – | Regulation: – | Overall: –</div>
      <div class="sticky-actions">
        <button class="primary" onclick="saveSession()">Save Session</button>
        <button class="ghost" onclick="newSession()">New Session</button>
        <div class="spacer"></div>
        <span class="muted small">Tip: Tab/Shift+Tab moves across fields quickly.</span>
      </div>
    </div>
  </div>
</div>

<!-- Monthly Reports -->
<div id="viewReport" style="display:none">
  <div class="card">
    <h2>Monthly Tracking Report</h2>
    <div class="row">
      <label>Month</label>
      <input type="month" id="reportMonth" />
      <label>Participant</label>
      <select id="reportParticipant"></select>
      <button class="primary" onclick="buildMonthlyReport()">Generate Report</button>
      <button class="ghost" onclick="window.print()">Print</button>
    </div>
    <div id="reportOutput" class="report" style="margin-top:10px;display:none"></div>
  </div>
</div>

<!-- Saved Sessions -->
<div id="viewSessions" style="display:none">
  <div class="card">
    <h2>Saved Sessions</h2>
    <div class="row">
      <button class="ghost" onclick="refreshSavedList()">Refresh</button>
      <button class="ghost" onclick="clearAllSessions()">Delete All Sessions</button>
    </div>
    <div id="sessionsList" class="small"></div>
  </div>
</div>

<script>
  // ------------------ Data Model & Storage ------------------
  const DEFAULT_ROWS = 15;
  const STORAGE_STATE = "mfs_tracker_state_v3";
  const STORAGE_SESSIONS = "mfs_tracker_sessions_v3";
  const DOMAINS = ["strength","focus","social","regulation"];

  let uiState = { groupName:"", sessionDate:"", coachName:"", participants:[] };
  let sessions = []; // array of session objects

  function emptyRow(i){ return {name:`Participant ${i}`, strengthBase:"", strength:"", focusBase:"", focus:"", socialBase:"", social:"", regulationBase:"", regulation:"", notes:""};}
  function initUiState(){
    uiState.groupName="";
    uiState.sessionDate=new Date().toISOString().slice(0,10);
    uiState.coachName="";
    uiState.participants=Array.from({length:DEFAULT_ROWS},(_,i)=>emptyRow(i+1));
  }

  function loadAll(){
    const st = localStorage.getItem(STORAGE_STATE);
    if(st){ try{ uiState=JSON.parse(st)||initUiState(); }catch{ initUiState(); } } else initUiState();
    const ss = localStorage.getItem(STORAGE_SESSIONS);
    if(ss){ try{ sessions=JSON.parse(ss)||[]; }catch{ sessions=[]; } } else sessions=[];
  }
  function saveAll(){
    localStorage.setItem(STORAGE_STATE, JSON.stringify(uiState));
    localStorage.setItem(STORAGE_SESSIONS, JSON.stringify(sessions));
  }

  // ------------------ Tracking View ------------------
  function renderTrack(){
    document.getElementById("groupName").value=uiState.groupName||"";
    document.getElementById("sessionDate").value=uiState.sessionDate||"";
    document.getElementById("coachName").value=uiState.coachName||"";

    const tbody=document.getElementById("tbody");
    tbody.innerHTML="";
    uiState.participants.forEach((p,idx)=>{
      const tr=document.createElement("tr");
      
      // Row number - sticky on mobile
      const tdNum = cellText(idx+1);
      tdNum.style.position = "sticky";
      tdNum.style.left = "0";
      tdNum.style.background = idx % 2 === 0 ? "var(--alt)" : "#fff";
      tdNum.style.zIndex = "1";
      tr.appendChild(tdNum);
      
      // name - sticky on mobile
      const tdName=document.createElement("td");
      tdName.style.position = "sticky";
      tdName.style.left = "40px";
      tdName.style.background = idx % 2 === 0 ? "var(--alt)" : "#fff";
      tdName.style.zIndex = "1";
      tdName.style.minWidth = "120px";
      const nameInput=document.createElement("input");
      nameInput.className="name-input";
      nameInput.value=p.name||`Participant ${idx+1}`;
      nameInput.oninput=e=>{ p.name=e.target.value; };
      tdName.appendChild(nameInput); tr.appendChild(tdName);
      
      // baseline and current selects for each domain
      ["strengthBase","strength","focusBase","focus","socialBase","social","regulationBase","regulation"].forEach(field=>{
        const td=document.createElement("td");
        td.appendChild(makeSelect(p,field)); tr.appendChild(td);
      });
      
      // notes
      const tdNotes=document.createElement("td");
      tdNotes.style.minWidth = "150px";
      const ta=document.createElement("textarea"); ta.className="notes"; ta.placeholder="Click templates above or type custom notes..."; ta.value=p.notes||"";
      ta.oninput=e=>{ p.notes=e.target.value; };
      ta.onfocus=e=>{ window.currentNotesField = e.target; }; // Track which field is focused
      tdNotes.appendChild(ta); tr.appendChild(tdNotes);
      tbody.appendChild(tr);
    });
    updateAverages();
  }
  function cellText(t){ const td=document.createElement("td"); td.textContent=String(t); return td; }
  function makeSelect(row,field){
    const sel=document.createElement("select"); sel.className="select";
    const optE=document.createElement("option"); optE.value=""; optE.textContent="—"; sel.appendChild(optE);
    for(let i=1;i<=5;i++){ const o=document.createElement("option"); o.value=String(i); o.textContent=i; sel.appendChild(o); }
    sel.value=row[field]===""?"":String(row[field]);
    sel.onchange=e=>{ row[field]=clamp(e.target.value); updateAverages(); };
    return sel;
  }
  function clamp(v){ if(v==="")return""; let n=Number(v); if(!Number.isFinite(n))return""; return Math.max(1,Math.min(5,Math.round(n))); }
  function updateAverages(){
    const r=uiState.participants;
    const avg=f=>{ const vals=r.map(x=>Number(x[f])).filter(Number.isFinite); if(!vals.length)return "–"; return (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2); };
    const aS=avg("strength"), aF=avg("focus"), aSo=avg("social"), aR=avg("regulation");
    const aSB=avg("strengthBase"), aFB=avg("focusBase"), aSoB=avg("socialBase"), aRB=avg("regulationBase");
    const all=[aS,aF,aSo,aR].filter(v=>v!=="–").map(Number);
    const allBase=[aSB,aFB,aSoB,aRB].filter(v=>v!=="–").map(Number);
    const overall=all.length?(all.reduce((a,b)=>a+b,0)/all.length).toFixed(2):"–";
    const overallBase=allBase.length?(allBase.reduce((a,b)=>a+b,0)/allBase.length).toFixed(2):"–";
    document.getElementById("averages").innerHTML=`<div>Current Averages — Strength: ${aS} | Focus: ${aF} | Social: ${aSo} | Regulation: ${aR} | Overall: ${overall}</div>
    <div style="margin-top:4px;color:var(--muted)">Baseline Averages — Strength: ${aSB} | Focus: ${aFB} | Social: ${aSoB} | Regulation: ${aRB} | Overall: ${overallBase}</div>`;
  }

  // quick actions
  function resetNames(){ uiState.participants=Array.from({length:DEFAULT_ROWS},(_,i)=>emptyRow(i+1)); renderTrack(); }
  function seedNames(){ uiState.participants.forEach((p,i)=>{ if(!p.name||p.name.startsWith("Participant ")) p.name=`Participant ${i+1}`;}); renderTrack(); }
  function fillBaseline(n=3){ uiState.participants.forEach(p=>{p.strengthBase=clamp(n); p.focusBase=clamp(n); p.socialBase=clamp(n); p.regulationBase=clamp(n);}); renderTrack(); }
  function clearScores(){ uiState.participants.forEach(p=>{ ["strengthBase","strength","focusBase","focus","socialBase","social","regulationBase","regulation"].forEach(k=>p[k]=""); p.notes="";}); renderTrack(); }

  // Template notes functionality
  function addTemplateNote(noteText) {
    const currentField = window.currentNotesField;
    if (currentField) {
      const currentValue = currentField.value.trim();
      const newValue = currentValue ? `${currentValue}; ${noteText}` : noteText;
      currentField.value = newValue;
      
      // Update the data model
      const participantIndex = Array.from(currentField.closest('tbody').children).indexOf(currentField.closest('tr'));
      if (participantIndex >= 0 && participantIndex < uiState.participants.length) {
        uiState.participants[participantIndex].notes = newValue;
      }
      
      currentField.focus(); // Keep focus on the field
      
      // Mobile haptic feedback if available
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    } else {
      alert('Please click in a notes field first, then select a template.');
    }
  }

  // Mobile-friendly auto-save functionality
  let autoSaveTimeout;
  function autoSaveState() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
      // Save current state automatically
      uiState.groupName=document.getElementById("groupName").value.trim();
      uiState.sessionDate=document.getElementById("sessionDate").value;
      uiState.coachName=document.getElementById("coachName").value.trim();
      saveAll();
    }, 2000); // Auto-save after 2 seconds of inactivity
  }

  // Add touch-friendly interactions
  function enhanceMobileExperience() {
    // Auto-save on input changes
    document.getElementById("groupName").addEventListener('input', autoSaveState);
    document.getElementById("sessionDate").addEventListener('change', autoSaveState);
    document.getElementById("coachName").addEventListener('input', autoSaveState);
    
    // Prevent zoom on double tap for iOS
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
    
    // Add touch feedback to template buttons
    document.querySelectorAll('.legend span').forEach(span => {
      span.addEventListener('touchstart', function() {
        this.style.transform = 'scale(0.95)';
        this.style.background = '#e9ecef';
      });
      span.addEventListener('touchend', function() {
        setTimeout(() => {
          this.style.transform = '';
          this.style.background = '';
        }, 150);
      });
    });
  }

  // Save as Session (append to sessions list)
  function saveSession(){
    // pull header
    uiState.groupName=document.getElementById("groupName").value.trim();
    uiState.sessionDate=document.getElementById("sessionDate").value;
    uiState.coachName=document.getElementById("coachName").value.trim();
    // clone clean
    const snapshot = JSON.parse(JSON.stringify(uiState));
    snapshot.id = `sess_${Date.now()}`;
    sessions.push(snapshot);
    saveAll();
    alert("Session saved!");
    refreshSavedList();
  }
  function newSession(){ if(!confirm("Start a new blank session?"))return; initUiState(); saveAll(); renderTrack(); }

  // ------------------ Sessions View ------------------
  function refreshSavedList(){
    const box=document.getElementById("sessionsList"); box.innerHTML="";
    if(!sessions.length){ box.textContent="No saved sessions yet."; return; }
    const tbl=document.createElement("table");
    const head=['Date','Group','Coach','Participants','Actions'];
    tbl.innerHTML=`<thead><tr>${head.map(h=>`<th>${h}</th>`).join("")}</tr></thead>`;
    const tb=document.createElement("tbody");
    sessions.slice().reverse().forEach(sess=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${sess.sessionDate||''}</td>
        <td>${escapeHtml(sess.groupName||'')}</td>
        <td>${escapeHtml(sess.coachName||'')}</td>
        <td>${(sess.participants||[]).length}</td>
        <td>
          <button class="ghost" onclick="loadIntoEditor('${sess.id}')">Load to Editor</button>
          <button class="ghost" onclick="deleteSession('${sess.id}')">Delete</button>
        </td>`;
      tb.appendChild(tr);
    });
    tbl.appendChild(tb); box.appendChild(tbl);
  }
  function loadIntoEditor(id){
    const s=sessions.find(x=>x.id===id); if(!s) return;
    uiState = JSON.parse(JSON.stringify(s));
    saveAll();
    switchTab('track');
    renderTrack();
    window.scrollTo({top:0,behavior:'smooth'});
  }
  function deleteSession(id){
    if(!confirm("Delete this session?"))return;
    sessions = sessions.filter(x=>x.id!==id); saveAll(); refreshSavedList();
  }
  function clearAllSessions(){
    if(!confirm("Delete ALL saved sessions?"))return;
    sessions=[]; saveAll(); refreshSavedList();
  }

  // ------------------ Reports ------------------
  function switchTab(t){
    document.getElementById("tabTrack").classList.toggle("active", t==='track');
    document.getElementById("tabReport").classList.toggle("active", t==='report');
    document.getElementById("tabSessions").classList.toggle("active", t==='sessions');
    document.getElementById("viewTrack").style.display = t==='track'?'block':'none';
    document.getElementById("viewReport").style.display = t==='report'?'block':'none';
    document.getElementById("viewSessions").style.display = t==='sessions'?'block':'none';
    if(t==='report') prepReportFilters();
    if(t==='sessions') refreshSavedList();
  }

  function prepReportFilters(){
    // month default = current month
    const m=document.getElementById("reportMonth");
    if(!m.value){
      const d=new Date(); m.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }
    // participants list from all sessions (unique)
    const sel=document.getElementById("reportParticipant");
    const names = new Set();
    sessions.forEach(s=> (s.participants||[]).forEach(p=>{ if(p.name) names.add(p.name.trim()); }));
    const arr=[...names].sort((a,b)=>a.localeCompare(b));
    sel.innerHTML = `<option value="">Select participant…</option>` + arr.map(n=>`<option>${escapeHtml(n)}</option>`).join("");
  }

  function buildMonthlyReport(){
    const monthStr=document.getElementById("reportMonth").value;
    const name=document.getElementById("reportParticipant").value;
    const out=document.getElementById("reportOutput");
    if(!monthStr || !name){ out.style.display="block"; out.innerHTML="<i>Please choose a month and participant.</i>"; return; }

    // filter sessions by month
    const [yyyy,mm]=monthStr.split("-");
    const filtered = sessions.filter(s=>{
      if(!s.sessionDate) return false;
      const [y,m]=s.sessionDate.split("-");
      return y===yyyy && m===mm;
    });

    // collect all entries for the chosen participant
    const entries = [];
    filtered.forEach(s=>{
      const row = (s.participants||[]).find(p=> (p.name||"").trim()===name.trim());
      if(row){
        entries.push({
          date: s.sessionDate,
          group: s.groupName||'',
          coach: s.coachName||'',
          strengthBase: numOrNull(row.strengthBase),
          strength: numOrNull(row.strength),
          focusBase: numOrNull(row.focusBase),
          focus: numOrNull(row.focus),
          socialBase: numOrNull(row.socialBase),
          social: numOrNull(row.social),
          regulationBase: numOrNull(row.regulationBase),
          regulation: numOrNull(row.regulation),
          notes: row.notes||""
        });
      }
    });

    // layout
    if(!entries.length){
      out.style.display="block";
      out.innerHTML = `<b>Monthly Tracking Report</b><div class="hr"></div>
        <div>No data for <b>${escapeHtml(name)}</b> in <b>${yyyy}-${mm}</b>.</div>`;
      return;
    }

    // compute weekly buckets (ISO week)
    const weeks = {};
    entries.forEach(e=>{
      const w = isoWeek(e.date);
      if(!weeks[w]) weeks[w]=[];
      weeks[w].push(e);
    });

    function avg(arr, key){
      const nums = arr.map(a=>a[key]).filter(n=>typeof n==='number' && !Number.isNaN(n));
      if(!nums.length) return "–";
      return (nums.reduce((a,b)=>a+b,0)/nums.length).toFixed(2);
    }

    // Build HTML report
    let html = `
      <div>
        <h2 style="margin:0 0 6px 0;">Monthly Tracking Report</h2>
        <div class="small muted">${yyyy}-${mm} • ${escapeHtml(name)}</div>
        <div class="hr"></div>
        <div class="small"><b>Domains:</b> Strength & Coordination, Focus & Engagement, Social Participation, Self-Regulation</div>
        <div class="small muted" style="margin-top:8px; line-height:1.3;">
          <b>Rating Scale:</b> 1=Maximum Support | 2=Moderate Support | 3=Some Support | 4=Minimal Support | 5=Independent
        </div>
      </div>
    `;

    // Add progress chart
    const strengthBaseAvg = avg(entries, 'strengthBase');
    const focusBaseAvg = avg(entries, 'focusBase');
    const socialBaseAvg = avg(entries, 'socialBase');
    const regulationBaseAvg = avg(entries, 'regulationBase');
    const strengthAvg = avg(entries, 'strength');
    const focusAvg = avg(entries, 'focus');
    const socialAvg = avg(entries, 'social');
    const regulationAvg = avg(entries, 'regulation');
    
    const domains = [
      {name: 'Strength &<br>Coordination', baseline: strengthBaseAvg, average: strengthAvg},
      {name: 'Focus &<br>Engagement', baseline: focusBaseAvg, average: focusAvg},
      {name: 'Social<br>Participation', baseline: socialBaseAvg, average: socialAvg},
      {name: 'Self-<br>Regulation', baseline: regulationBaseAvg, average: regulationAvg}
    ];

    html += `
      <div class="section">
        <b>Progress Chart - Baseline vs Monthly Average</b>
        <div class="chart">
          <div class="chart-container">
            <div class="chart-y-axis">
              <span>5</span><span>4</span><span>3</span><span>2</span><span>1</span>
            </div>
            <div class="chart-bars">
              ${domains.map(domain => {
                const baselineHeight = domain.baseline !== "–" ? (parseFloat(domain.baseline) / 5) * 200 : 0;
                const averageHeight = domain.average !== "–" ? (parseFloat(domain.average) / 5) * 200 : 0;
                return `
                  <div class="chart-group">
                    <div class="chart-group-bars">
                      <div class="chart-bar baseline" style="height: ${baselineHeight}px;">
                        <div class="chart-value">${domain.baseline}</div>
                      </div>
                      <div class="chart-bar average" style="height: ${averageHeight}px;">
                        <div class="chart-value">${domain.average}</div>
                      </div>
                    </div>
                    <div class="chart-label">${domain.name}</div>
                  </div>
                `;
              }).join('')}
            </div>
            <div class="chart-legend">
              <div class="chart-legend-item">
                <div class="chart-legend-color" style="background:#4a90e2;"></div>
                <span>Baseline</span>
              </div>
              <div class="chart-legend-item">
                <div class="chart-legend-color" style="background:#7ed321;"></div>
                <span>Monthly Average</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    html += `
      <div class="section">
        <b>Session Details</b>
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Group</th><th>Coach</th>
              <th>Strength</th><th>Focus</th><th>Social</th><th>Regulation</th><th>Session Avg</th><th>Notes</th>
            </tr>
          </thead>
          <tbody>
            ${entries.sort((a,b)=>a.date.localeCompare(b.date)).map(e=>{
              const sessionScores = [e.strength, e.focus, e.social, e.regulation].filter(s => typeof s === 'number');
              const sessionAvg = sessionScores.length > 0 ? (sessionScores.reduce((a,b)=>a+b,0)/sessionScores.length).toFixed(2) : "–";
              return `
                <tr>
                  <td>${e.date}</td><td>${escapeHtml(e.group)}</td><td>${escapeHtml(e.coach)}</td>
                  <td>${fmt(e.strength)}</td><td>${fmt(e.focus)}</td><td>${fmt(e.social)}</td><td>${fmt(e.regulation)}</td>
                  <td><b>${sessionAvg}</b></td>
                  <td>${escapeHtml(e.notes)}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>
    `;

    // Weekly averages table
    const weekRows = Object.keys(weeks).sort().map(w=>{
      const arr=weeks[w];
      const weekSessionAvgs = arr.map(e => {
        const sessionScores = [e.strength, e.focus, e.social, e.regulation].filter(s => typeof s === 'number');
        return sessionScores.length > 0 ? sessionScores.reduce((a,b)=>a+b,0)/sessionScores.length : null;
      }).filter(a => a !== null);
      const avgSessionAvg = weekSessionAvgs.length > 0 ? (weekSessionAvgs.reduce((a,b)=>a+b,0)/weekSessionAvgs.length).toFixed(2) : "–";
      
      return `<tr>
        <td>Week ${w}</td>
        <td>${avg(arr,'strength')}</td>
        <td>${avg(arr,'focus')}</td>
        <td>${avg(arr,'social')}</td>
        <td>${avg(arr,'regulation')}</td>
        <td><b>${avgSessionAvg}</b></td>
      </tr>`;
    }).join("");

    html += `
      <div class="section">
        <b>Weekly Averages</b>
        <table>
          <thead><tr><th>Week</th><th>Strength</th><th>Focus</th><th>Social</th><th>Regulation</th><th>Session Avg</th></tr></thead>
          <tbody>${weekRows}</tbody>
        </table>
      </div>
    `;

    // Monthly overall
    const monthlySessionAvgs = entries.map(e => {
      const sessionScores = [e.strength, e.focus, e.social, e.regulation].filter(s => typeof s === 'number');
      return sessionScores.length > 0 ? sessionScores.reduce((a,b)=>a+b,0)/sessionScores.length : null;
    }).filter(a => a !== null);
    const avgMonthlySessionAvg = monthlySessionAvgs.length > 0 ? (monthlySessionAvgs.reduce((a,b)=>a+b,0)/monthlySessionAvgs.length).toFixed(2) : "–";
    
    html += `
      <div class="section">
        <b>Monthly Summary</b>
        <table>
          <thead><tr><th>Strength</th><th>Focus</th><th>Social</th><th>Regulation</th><th>Session Avg</th></tr></thead>
          <tbody><tr>
            <td>${avg(entries,'strength')}</td>
            <td>${avg(entries,'focus')}</td>
            <td>${avg(entries,'social')}</td>
            <td>${avg(entries,'regulation')}</td>
            <td><b>${avgMonthlySessionAvg}</b></td>
          </tr></tbody>
        </table>
      </div>
    `;

    out.style.display="block";
    out.innerHTML = html;
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function overallAvg(arr){
    const dims=['strength','focus','social','regulation'];
    const vals=[];
    arr.forEach(e=>{
      dims.forEach(k=>{ if(typeof e[k]==='number') vals.push(e[k]); });
    });
    if(!vals.length) return "–";
    return (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2);
  }

  function isoWeek(dateStr){
    // returns ISO week number (1-53)
    const d=new Date(dateStr+"T12:00:00"); // force midday
    const target=new Date(d.valueOf());
    const dayNr=(d.getDay()+6)%7;
    target.setDate(target.getDate()-dayNr+3);
    const firstThursday=new Date(target.getFullYear(),0,4);
    const dayDiff=(target-firstThursday)/(24*3600*1000);
    return 1 + Math.floor(dayDiff/7);
  }
  function numOrNull(v){ const n=Number(v); return Number.isFinite(n)?n:null; }
  function fmt(v){ return (typeof v==='number' && !Number.isNaN(v)) ? v : "–"; }
  function escapeHtml(s){ return (s||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  // ------------------ Import/Export ------------------
  function exportJSON(){
    const blob=new Blob([JSON.stringify({uiState,sessions},null,2)],{type:"application/json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
    a.download=`mfs_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
  }
  function exportCSV(){
    if(!sessions.length){ alert("No sessions saved yet."); return; }
    const headers=["SessionID","Date","Group","Coach","#","Participant","StrengthBase","Strength","FocusBase","Focus","SocialBase","Social","RegulationBase","Regulation","Notes"];
    const lines=[headers.join(",")];
    sessions.forEach(s=>{
      (s.participants||[]).forEach((p,i)=>{
        lines.push([
          s.id, s.sessionDate, csv(p.sGroup||s.groupName||""), csv(s.coachName||""), i+1,
          csv(p.name||""), p.strengthBase||"", p.strength||"", p.focusBase||"", p.focus||"", p.socialBase||"", p.social||"", p.regulationBase||"", p.regulation||"", csv(p.notes||"")
        ].join(","));
      });
    });
    const blob=new Blob([lines.join("\n")],{type:"text/csv"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
    a.download=`mfs_sessions_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(a.href);
  }
  function csv(s){ s=String(s); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }

  document.getElementById("importJson").addEventListener("change",(e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const obj=JSON.parse(reader.result);
        if(obj.sessions && Array.isArray(obj.sessions)) sessions=obj.sessions;
        if(obj.uiState) uiState=obj.uiState;
        saveAll(); renderTrack(); alert("Imported!");
      }catch{ alert("Invalid JSON."); }
    };
    reader.readAsText(f); e.target.value="";
  });

  // ------------------ Boot ------------------
  loadAll();
  renderTrack();
  prepReportFilters();
  
  // Initialize mobile enhancements
  if ('ontouchstart' in window) {
    enhanceMobileExperience();
  }

</script>
</body>
</html>
